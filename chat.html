<script>
  const firebaseUrl = "https://campana-55221-default-rtdb.firebaseio.com/messages.json";

  let lastTimestampShown = 0;

  document.addEventListener("DOMContentLoaded", () => {
    askNotificationPermission();
    document.getElementById("text").focus();

    // Botón "Te necesito"
    document.getElementById("btn-tene").addEventListener("click", () => {
      sendTeNecesito();
    });

    // Cargar usuario guardado
    const savedUser = localStorage.getItem("username");
    if (savedUser) {
      document.getElementById("username").value = savedUser;
    }
  });

  function askNotificationPermission() {
    if ("Notification" in window) {
      Notification.requestPermission().then((permission) => {
        console.log("Permiso notificaciones:", permission);
      });
    }
  }

  function sendMessage() {
    const user = document.getElementById("username").value.trim();
    const text = document.getElementById("text").value.trim();
    const timestamp = Date.now();

    if (!user || !text) {
      alert("Escribí tu nombre y mensaje");
      return;
    }

    localStorage.setItem("username", user);

    fetch(firebaseUrl, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify({ user, text, timestamp }),
    }).then(() => {
      document.getElementById("text").value = "";
      document.getElementById("text").focus();
      loadMessages();
    });

    showToast(`${user} dice: ${text}`);
    showNotification(user, text);
  }

  function sendTeNecesito() {
    const user = document.getElementById("username").value.trim() || "Anónimo";
    const text = "¡Te necesito!";
    const timestamp = Date.now();

    localStorage.setItem("username", user);

    fetch(firebaseUrl, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify({ user, text, timestamp }),
    }).then(() => {
      document.getElementById("text").focus();
      loadMessages();
    });

    showToast(`${user} dice: ${text}`);
    showNotification(user, text);
  }

  function showNotification(user, text) {
    if ("Notification" in window && Notification.permission === "granted") {
      new Notification(`${user} dice:`, {
        body: text,
      });
    }
  }

  function loadMessages() {
    fetch(firebaseUrl)
      .then((res) => res.json())
      .then((data) => {
        const chat = document.getElementById("chat");
        chat.innerHTML = "";

        const messages = Object.values(data || {}).sort(
          (a, b) => a.timestamp - b.timestamp
        );

        for (const msg of messages) {
          const date = new Date(msg.timestamp).toLocaleString();
          chat.innerHTML += `
            <div class="msg">
              <div class="text"><strong>${msg.user}:</strong> ${msg.text}</div>
              <div class="meta">${date}</div>
            </div>
          `;

          // ✅ Mostrar toast sólo si es un mensaje nuevo
          if (msg.timestamp > lastTimestampShown) {
            showToast(`${msg.user} dice: ${msg.text}`);
            lastTimestampShown = msg.timestamp;
          }
        }
      });
  }

  function showToast(message) {
    const container = document.getElementById("toast-container");
    const toast = document.createElement("div");
    toast.className = "toast";
    toast.textContent = message;

    container.appendChild(toast);

    // Forzar reflow para activar transición
    window.getComputedStyle(toast).opacity;
    toast.classList.add("show");

    setTimeout(() => {
      toast.classList.remove("show");
      setTimeout(() => {
        toast.remove();
      }, 500);
    }, 3000);
  }

  setInterval(loadMessages, 3000);
  loadMessages();
</script>
